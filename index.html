<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Flatten Slab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #22c55e;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2937;
    }
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--bg), #0b1224);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }
    .container {
      width: min(1200px, 100%);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }
    h1 {
      margin: 0 0 12px;
      font-size: 26px;
    }
    p {
      margin: 0 0 14px;
      color: var(--muted);
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px 16px;
      align-items: end;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--muted);
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1224;
      color: var(--text);
      font-size: 15px;
    }
    button {
      padding: 12px 14px;
      border: none;
      border-radius: 12px;
      background: var(--accent);
      color: #0b1224;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.25);
    }
    textarea {
      width: 100%;
      min-height: 380px;
      resize: vertical;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0b1224;
      color: var(--text);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 14px;
    }
    .errors {
      background: #431420;
      border: 1px solid #7f1d35;
      color: #fecdd3;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
    }
    .copy-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .subtext {
      color: var(--muted);
      font-size: 13px;
      margin: 0;
    }
    .field-error {
      background: #431420;
      border: 1px solid #7f1d35;
      color: #fecdd3;
      padding: 6px 10px;
      border-radius: 8px;
      margin-top: 6px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Flatten a slab</h1>
      <p>Enter your slab and tool settings.</p>

      <div id="form-errors" class="errors" style="display:none;">
        Please fix the highlighted fields.
      </div>

      <form id="slab-form" novalidate>
        <div>
          <label for="width">Width (X axis)</label>
          <input type="number" id="width" name="width" step="any" min="0.01" required>
          <div class="field-error" id="width-error" style="display:none;"></div>
        </div>
        <div>
          <label for="length">Length (Y axis)</label>
          <input type="number" id="length" name="length" step="any" min="0.01" required>
          <div class="field-error" id="length-error" style="display:none;"></div>
        </div>
        <div>
          <label for="stepover">Stepover</label>
          <input type="number" id="stepover" name="stepover" step="any" value="1.24">
          <div class="field-error" id="stepover-error" style="display:none;"></div>
        </div>
        <div>
          <label for="depth">Depth per pass</label>
          <input type="number" id="depth" name="depth" step="any" min="0.001" value="0.1">
          <div class="field-error" id="depth-error" style="display:none;"></div>
        </div>
        <div>
          <label for="passes">Passes</label>
          <input type="number" id="passes" name="passes" step="1" min="1" max="50" value="1">
          <div class="field-error" id="passes-error" style="display:none;"></div>
        </div>
        <div>
          <label for="feed_rate">Feed rate (IPM)</label>
          <input type="number" id="feed_rate" name="feed_rate" step="any" min="1" value="250">
          <div class="field-error" id="feed_rate-error" style="display:none;"></div>
        </div>
        <div>
          <label for="spindle_speed">Spindle speed (RPM)</label>
          <input type="number" id="spindle_speed" name="spindle_speed" step="any" min="1" value="12000">
          <div class="field-error" id="spindle_speed-error" style="display:none;"></div>
        </div>
        <div>
          <label for="skip_direction">Skip direction</label>
          <select id="skip_direction" name="skip_direction">
            <option value="">No skip</option>
            <option value="forward">Skip forward moves</option>
            <option value="backwards">Skip backward moves</option>
          </select>
        </div>
        <div>
          <button type="submit">Generate G-code</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">Result</h2>
      <div class="copy-row">
        <p class="subtext">Copy and paste this into your CNC controller once zeroed.</p>
        <button type="button" id="copy-btn">Copy G-code</button>
      </div>
      <textarea id="gcode-output" readonly placeholder="G-code will appear here after you submit the form."></textarea>
    </div>
  </div>

  <script>
    const SAFE_DISTANCE = 0.1;

    /** Round to 4 decimal places to avoid IEEE 754 floating-point noise. */
    function r(n) {
      return parseFloat(n.toFixed(4));
    }

    function generateGcode({ width, length, stepover, depth, passes, feedRate, spindleSpeed, skipDirection }) {
      const step = Math.abs(stepover);
      if (step === 0) {
        throw new Error("Stepover must be non-zero.");
      }
      let numXSteps = Math.ceil(width / step / 2);
      if (skipDirection) {
        numXSteps *= 2;
      }

      const lines = [
        "G90",
        "F" + feedRate,
        "G0 Z" + SAFE_DISTANCE,
        "G0 X0 Y0",
        "S" + spindleSpeed + " M3",
      ];

      let time = 0;

      for (let i = 0; i < passes; i++) {
        const passNum = i + 1;
        lines.push("(Pass number " + passNum + ")");
        lines.push("G0 X0 Y0");
        lines.push("G1 Z-" + r(passNum * depth));
        for (let xStep = 0; xStep < numXSteps; xStep++) {
          const stepIndex = skipDirection ? xStep / 2 : xStep;
          const startX = r(step * stepIndex * 2);
          lines.push("X" + startX);
          lines.push("Y" + length);
          const nextX = r(step * (stepIndex * 2 + (skipDirection === "backwards" ? 0 : 1)));
          lines.push("X" + nextX);
          lines.push("Y0");
          time += 2 * (length + stepover) / feedRate;
        }
        lines.push("Z" + r(SAFE_DISTANCE - i * depth));
      }

      lines.push("M30");
      lines.push(";Estimated running time: " + time.toFixed(1) + " minutes");
      return lines.join("\n");
    }

    function showError(fieldId, message) {
      const el = document.getElementById(fieldId + "-error");
      if (el) {
        el.textContent = message;
        el.style.display = "block";
      }
    }

    function clearErrors() {
      document.querySelectorAll(".field-error").forEach(el => {
        el.style.display = "none";
        el.textContent = "";
      });
      document.getElementById("form-errors").style.display = "none";
    }

    function validateForm() {
      clearErrors();
      const errors = [];

      const width = parseFloat(document.getElementById("width").value);
      if (isNaN(width) || width < 0.01) {
        showError("width", "Width must be at least 0.01.");
        errors.push("width");
      }

      const length = parseFloat(document.getElementById("length").value);
      if (isNaN(length) || length < 0.01) {
        showError("length", "Length must be at least 0.01.");
        errors.push("length");
      }

      const stepover = parseFloat(document.getElementById("stepover").value);
      if (isNaN(stepover) || stepover === 0) {
        showError("stepover", "Stepover must be a non-zero number.");
        errors.push("stepover");
      }

      const depth = parseFloat(document.getElementById("depth").value);
      if (isNaN(depth) || depth < 0.001) {
        showError("depth", "Depth must be at least 0.001.");
        errors.push("depth");
      }

      const passes = parseInt(document.getElementById("passes").value, 10);
      if (isNaN(passes) || passes < 1 || passes > 50) {
        showError("passes", "Passes must be between 1 and 50.");
        errors.push("passes");
      }

      const feedRate = parseFloat(document.getElementById("feed_rate").value);
      if (isNaN(feedRate) || feedRate < 1) {
        showError("feed_rate", "Feed rate must be at least 1.");
        errors.push("feed_rate");
      }

      const spindleSpeed = parseFloat(document.getElementById("spindle_speed").value);
      if (isNaN(spindleSpeed) || spindleSpeed < 1) {
        showError("spindle_speed", "Spindle speed must be at least 1.");
        errors.push("spindle_speed");
      }

      const skipDirection = document.getElementById("skip_direction").value || null;

      if (errors.length > 0) {
        document.getElementById("form-errors").style.display = "block";
        return null;
      }

      return { width, length, stepover, depth, passes, feedRate, spindleSpeed, skipDirection };
    }

    document.getElementById("slab-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const params = validateForm();
      if (!params) return;

      const output = document.getElementById("gcode-output");
      try {
        output.value = generateGcode(params);
      } catch (err) {
        output.value = "Error: " + err.message;
      }
    });

    const copyBtn = document.getElementById("copy-btn");
    const output = document.getElementById("gcode-output");
    copyBtn.addEventListener("click", async () => {
      if (!output.value.trim()) {
        copyBtn.textContent = "Nothing to copy";
        setTimeout(() => copyBtn.textContent = "Copy G-code", 1200);
        return;
      }
      try {
        await navigator.clipboard.writeText(output.value);
        copyBtn.textContent = "Copied!";
      } catch (err) {
        output.select();
        document.execCommand("copy");
        copyBtn.textContent = "Copied!";
      }
      setTimeout(() => copyBtn.textContent = "Copy G-code", 1400);
    });
  </script>
</body>
</html>
